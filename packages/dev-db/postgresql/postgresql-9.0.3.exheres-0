# Copyright 2011 Mike Kazantsev
# Copyright 2008-2011 Ingmar Vanhassel <ingmar@exherbo.org>
# Distributed under the terms of the GNU General Public License v2

PSQL_MAJOR_VERSION=$(ever range 1-2)

SUMMARY="PostgreSQL is a powerful, open source relational database system"
DESCRIPTION=""

HOMEPAGE="http://www.postgresql.org"
DOWNLOADS="mirror://${PN}/source/v${PV}/${PNV}.tar.bz2"

LICENCES="PostgreSQL"
SLOT="0"
PLATFORMS="~amd64 ~x86"
MYOPTIONS="pam perl python readline ssl tcl"

DEPENDENCIES="
    build:
        dev-util/pkg-config
        sys-devel/flex
        sys-devel/gettext
    build+run:
        group/postgres
        user/postgres
        pam? ( sys-libs/pam )
        perl? ( dev-lang/perl:= )
        python? ( dev-lang/python:= )
        readline? ( sys-libs/readline )
        ssl? ( dev-libs/openssl )
        tcl? ( dev-lang/tcl:= )
"

BUGS_TO="mk.fraggod@gmail.com"
REMOTE_IDS="freshmeat:pgsql"
UPSTREAM_DOCUMENTATION="
${HOMEPAGE}/docs/manuals/ [[ lang = en description = [ PostgreSQL Manuals ] ]]
${HOMEPAGE}/docs/faq/ [[ lang = en description = [ FAQ ] ]]
${HOMEPAGE}/support/security.html [[ lang = en description = [ Security Information ] ]]
"
UPSTREAM_RELEASE_NOTES="
http://wiki.postgresql.org/wiki/WhatsNew${PSQL_MAJOR_VERSION//.}
${HOMEPAGE}/docs/${PSQL_MAJOR_VERSION}/static/release-${PSQL_MAJOR_VERSION//./-}.html
"


DEFAULT_SRC_CONFIGURE_OPTION_WITHS=(
    pam perl python readline 'ssl openssl' tcl
)
DEFAULT_SRC_CONFIGURE_PARAMS=(
    --hates=docdir
    --enable-nls
    --with-docdir=/usr/share/doc/${PNVR}
    --with-system-tzdata=/usr/share/zoneinfo
    --with-zlib
    # Force thread-safety on, 64bit sandbox breaks the ./configure test, Gentoo #234762
    --enable-thread-safety-force
)

src_prepare() {
    sed -e "s|/no/such/location|${WORK}/src/test/regress/tmp_check/no/such/location|g" -i src/test/regress/{input,output}/tablespace.source
}

src_install() {
    default

    keepdir /var/run/postgresql
    edo chown postgres:postgres "${IMAGE}"/var/run/postgresql
    edo chmod 0770 "${IMAGE}"/var/run/postgresql
}

src_test() {
    esandbox allow_net 'unix:/tmp/.s.PGSQL.*'
    default
    esandbox disallow_net 'unix:/tmp/.s.PGSQL.*'
}
