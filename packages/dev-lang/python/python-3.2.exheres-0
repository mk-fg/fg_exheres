# Copyright 2011 Mike Kazantsev
# Copyright 2011 Mike Kazantsev
# Copyright 2007-2007 Bryan Ã˜stergaard
# Copyright 2008 Ali Polatel
# Copyright 2009, 2010 Ingmar Vanhassel
# Distributed under the terms of the GNU General Public License v2
# Based in part upon 'python-2.5.2-r4.ebuild' from Gentoo, which is:
#  Copyright 1999-2008 Gentoo Foundation

require flag-o-matic python alternatives\
    autotools [ supported_autoconf=[ 2.5 ] supported_automake=[ 1.11 1.10 ] ]

MY_PNV="Python-${PV}"

SUMMARY="Python interpreter"

HOMEPAGE="http://www.${PN}.org/"
DOWNLOADS="http://${PN}.org/ftp/${PN}/${PV}/${MY_PNV}.tar.xz"

LICENCES="PSF-2.2"
SLOT="$(ever range 1-2)"
PLATFORMS="~amd64 ~x86"
MYOPTIONS="dbm examples ipv6 readline sqlite tk
    ( berkdb gdbm ) [[ requires = dbm ]]
    dbm? ( ( berkdb gdbm ) [[ number-selected = at-least-one ]] )
"

DEPENDENCIES="
    build:
        dev-util/pkg-config
    build+run:
        app-arch/bzip2
        dev-libs/expat
        dev-libs/libffi
        dev-libs/openssl
        sys-libs/zlib[>=1.1.3]
        berkdb? ( sys-libs/db:=[>=3.3&<=4.7] )
        gdbm? ( sys-libs/gdbm )
        readline? ( sys-libs/readline[>=4.1] )
        sqlite? ( dev-db/sqlite:3[>=3.0.8] )
        tk? ( dev-lang/tk[>=8.0] )
"

BUGS_TO="mk.fraggod@gmail.com"


WORK="${WORKBASE}/${MY_PNV}"
DEFAULT_SRC_CONFIGURE_PARAMS=( --enable-shared --with-system-expat --with-system-ffi )
DEFAULT_SRC_CONFIGURE_OPTION_ENABLES=( ipv6 )

python-build_src_prepare() {
    [[ -d ${FILES}/${PV} ]] && expatch "${FILES}/${PV}/"

    edo sed -i -e "s:@@EXHERBO_LIBDIR@@:${LIBDIR}:g" \
        Lib/distutils/command/install.py \
        Lib/distutils/sysconfig.py \
        Lib/site.py \
        Makefile.pre.in \
        Modules/Setup.dist \
        Modules/getpath.c \
        setup.py

    eautoreconf
}

python-build_src_configure() {
    # dbm module can link to berkdb or gdbm.
    # default to gdbm when both are enabled.
    local disable

    option berkdb   || option gdbm || disable="_dbm"
    option berkdb   || disable="${disable} _bsddb"
    if ever at_least 3 ; then
        option gdbm	 || disable="${disable} _gdbm"
    else
        option gdbm	 || disable="${disable} gdbm"
    fi
    option readline || disable="${disable} readline"
    option sqlite   || disable="${disable} _sqlite3"
    option tk	   || disable="${disable} _tkinter"
    export PYTHON_DISABLE_MODULES="${disable}"

    export OPT="${CFLAGS}"
    export CPPFLAGS="$(pkg-config --cflags-only-I libffi) ${CPPFLAGS}"

    default
}

python-build_src_install() {
    default

    ! ever at_least 3.1 && edo rm "${IMAGE}"/usr/bin/smtpd.py
    ever at_least 3 && edo mv "${IMAGE}"/usr/bin/2to3 "${IMAGE}"/usr/bin/2to3-3
    edo mv "${IMAGE}"/usr/${LIBDIR}/{${PN}${SLOT}/config,}/libpython${SLOT}.a

    # alternatives handling
    local alternatives=("${PN}$(ever major)" "${SLOT}" "${SLOT}")
    PYTHON_MAJOR="$(ever at_least 3 && echo 3)"
    edo rm "${IMAGE}/usr/bin/python${SLOT}"
    edo mv "${IMAGE}/usr/bin/python${SLOT}-config" "${IMAGE}/usr/bin/python${PYTHON_MAJOR}-config"

    alternatives+=(
        /usr/bin/2to3$(ever at_least 3 && echo "-")${PYTHON_MAJOR} 2to3${SLOT}
        /usr/bin/idle${PYTHON_MAJOR} idle${SLOT}
        /usr/bin/pydoc${PYTHON_MAJOR} pydoc${SLOT}
        /usr/bin/python${PYTHON_MAJOR} python${SLOT}
        /usr/bin/python${PYTHON_MAJOR}-config python${SLOT}-config
    )

    alternatives_for "${alternatives[@]}"
}

