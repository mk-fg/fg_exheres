# Copyright 2011 Mike Kazantsev
# Copyright 2008 Daniel Mierswa <impulze@impulze.org>
# Distributed under the terms of the GNU General Public License v2
# Based in part upon 'iproute2-2.6.26-r1.ebuild' from Gentoo, which is:
#	 Copyright 1999-2008 Gentoo Foundation.

SUMMARY="libnetlink from iproute2 package."

HOMEPAGE="http://www.linuxfoundation.org/en/Net:Iproute2"
DOWNLOADS="
    http://dev.exherbo.org/~philantrop/distfiles/iproute2-${PV}.tar.bz2
    http://devresources.linux-foundation.org/dev/iproute2/download/iproute2-${PV}.tar.bz2
"

LICENCES="GPL-2"
SLOT="0"
PLATFORMS="~amd64 ~arm ~ppc64 ~x86"
MYOPTIONS=""

DEPENDENCIES="
    build:
        sys-kernel/linux-headers[>=2.6.38]
"

BUGS_TO="mk.fraggod@gmail.com"


WORK="${WORKBASE}/iproute2-${PV}"

DEFAULT_SRC_COMPILE_PARAMS+=(
    CC="${CC}"
    AR="${AR}"
    LIBDIR=/usr/${LIBDIR}
    IPT_LIB_DIR=/usr/${LIBDIR}
)

DEFAULT_SRC_INSTALL_PARAMS+=(
    LIBDIR=/usr/${LIBDIR}
    DESTDIR="${IMAGE}"
    DOCDIR=/usr/share/doc/${PNVR}
    MANDIR=/usr/share/man
)

src_prepare() {
    # apply version-specific patches
    default

    # use system headers
    edo rm -r include/linux include/netinet

    # fix hardcoded -O2 and allow user CFLAGS
    # The -DRTPROT_DHCP is an evil hack, but I'm not sure of a better
    # fix for now.
    edo sed -e '/^CCOPTS =/s: -O2 : :' \
            -e 's:^CFLAGS =:CFLAGS += -DRTPROT_DHCP=16:' \
            -i Makefile

    edo sed -e 's:$(DESTDIR)/lib:$(DESTDIR)$(LIBDIR):g' -i netem/Makefile
}

src_configure() {
    edo echo 'TC_CONFIG_ATM=n' >> Config
}

src_install() {
    insinto /usr/$LIBDIR
    doins lib/libnetlink.a

    insinto /usr/include
    doins include/libnetlink.h

    doman man/man3/libnetlink.3
}
