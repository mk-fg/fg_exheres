# Copyright 2011 Mike Kazantsev
# Copyright 2008, 2009 Ingmar Vanhassel <ingmar@exherbo.org>
# Distributed under the terms of the GNU General Public License v2

require mozilla [ co_project=xulrunner supported_nspr="[>=4.8.7]" supported_nss="[>=3.12.9]" ]

SUMMARY="Mozilla runtime for XUL+XPCOM applications"
DESCRIPTION="
XULRunner is a Mozilla runtime package that can be used to bootstrap XUL+XPCOM
applications that are as rich as Firefox and Thunderbird. It will provide
mechanisms for installing, upgrading, and uninstalling these applications.
XULRunner will also provide libxul, a solution which allows the embedding of
Mozilla technologies in other projects and products.
"

HOMEPAGE="http://developer.mozilla.org/en/docs/XULRunner"
DOWNLOADS="ftp://ftp.mozilla.org/pub/mozilla.org/firefox/releases/4.0/source/firefox-4.0.source.tar.bz2"

LICENCES="|| ( MPL-1.1 GPL-2 LGPL-2.1 )"
MYOPTIONS="
	dbus
	gnome [[ description = [ Enable the GNOME component for desktop intergration ] ]]
	libnotify [[ description = [ Show notifications with libnotify ( requires gnome option ) ] ]]
	startup-notification
	webm
"

DEPENDENCIES="
	build:
		dev-util/pkg-config
		dev-lang/python:*[>=2.4]
	build+run:
		app-arch/zip
		app-arch/unzip
		app-spell/hunspell
		dev-db/sqlite[>=3.7.1]
		dev-libs/atk
		dev-libs/glib:2
		dev-libs/libevent
		dev-libs/libIDL[>=0.6.3]
		media-libs/freetype:2[>=2.1.0]
		media-libs/fontconfig
		media-libs/jpeg
		x11-libs/cairo[>=1.10.2-r1][X]
		x11-libs/gtk+:2[>=2.10.0]
		x11-libs/pango[>=1.14.0][X]
		x11-libs/pixman
		x11-libs/libX11
		x11-libs/libXext
		x11-libs/libXrender
		x11-libs/libXt
		sys-sound/alsa-lib
		dbus? ( sys-apps/dbus[>=0.60]
			dev-libs/dbus-glib[>=0.60] )
		gnome? ( gnome-platform/GConf:2
			gnome-platform/gnome-vfs[>=2.0]
			gnome-platform/libgnomeui:2[>=2.2.0] )
		libnotify? ( x11-libs/libnotify[>=0.4] )
		startup-notification? ( x11-libs/startup-notification[>=0.8] )
		webm? ( media-libs/libvpx )
"

ECONF_SOURCE="${WORKBASE}/mozilla-$(ever range 1-3 ${PV})"

src_prepare() {
	cd "${ECONF_SOURCE}"
	mozilla_src_prepare
}

# TODO: Java XPCOM bridge
MOZILLA_SRC_CONFIGURE_PARAMS=(
	--disable-crashreporter
	--disable-installer
	--disable-updater
	--disable-javaxpcom
	--disable-necko-wifi
	--enable-crypto
	--enable-default-toolkit=cairo-gtk2
	--enable-svg
	--enable-raw
	--enable-ogg
	--enable-wave
	--enable-system-cairo
	--enable-system-hunspell
	--hates=docdir
	--with-system-bz2
	--with-system-jpeg
	--with-system-libevent
	--with-system-sqlite
	--with-system-zlib
	--with-system-bz2
	--without-system-png # Requires patch for APNG support
)
MOZILLA_SRC_CONFIGURE_OPTION_ENABLES=(
	'webm webm'
	'gnome gio'
	'gnome gnomeui'
	'gnome gnomevfs'
	dbus
	libnotify
	startup-notification
)
MOZILLA_SRC_CONFIGURE_OPTION_WITHS=( 'webm system-libvpx' )

src_install() {
	default

	nonfatal edo rmdir ${IMAGE}/usr/include/xulrunner/nss # might not exist, might not be empty
	edo rmdir ${IMAGE}/usr/lib/xulrunner/plugins

	hereenvd 50xulrunner <<EOF
LDPATH="/usr/$LIBDIR/xulrunner"
EOF
}
