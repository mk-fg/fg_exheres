# Copyright 2011 Mike Kazantsev
# Copyright 2008 Ingmar Vanhassel <ingmar@exherbo.org>
# Copyright 2009 Bo Ã˜rsted Andresen <zlin@exherbo.org>
# Distributed under the terms of the GNU General Public License v2
# Based in part upon 'nss-3.12.ebuild' from Gentoo, which is:
#	 Copyright 1999-2008 Gentoo Foundation.

SUMMARY="Mozilla's Network Security Services library that implements PKI support"

HOMEPAGE="http://www.mozilla.org/projects/security/pki/nss/"
DOWNLOADS="ftp://ftp.mozilla.org/pub/mozilla.org/security/${PN}/releases/NSS_${PV//./_}_RTM/src/${PNV}.tar.gz"

LICENCES="|| ( MPL-1.1 GPL-2 LGPL-2.1 )"
SLOT="0"
PLATFORMS="~amd64 ~ppc64 ~x86"
MYOPTIONS="
    debug
    utils [[ description = [ Install the included utilities, e. g. certutil for cert management ] ]]
    platform: amd64 ppc64
"

DEPENDENCIES="
    build+run:
        dev-db/sqlite:3
        dev-libs/nspr[>=4.7.4]
"

BUGS_TO="mk.fraggod@gmail.com"
UPSTREAM_RELEASE_NOTES="${HOMEPAGE}${PNV}/${PNV}-release-notes.html"

# make --dry-run check aborts
RESTRICT="test"


WORK="${WORKBASE}/${PNV}/mozilla/security/nss"

src_configure() {
    # Respect LDFLAGS
    export DSO_LDOPTS="${LDFLAGS}"

    # Respect user AR
    edo sed -e "/^AR[ \t]*= ar cr/s:ar:${AR}:" -i ../coreconf/UNIX.mk

    option platform:amd64 || option platform:ppc64 && export USE_64=1
}

src_compile() {
    emake -j1 \
        CC="${CC}" \
        CCC="${CXX}" \
        RANLIB="${RANLIB}" \
        NSDISTMODE=copy \
        NSPR_INCLUDE_DIR=/usr/include/nspr \
        NSS_ENABLE_ECC=1 \
        NSS_USE_SYSTEM_SQLITE=1 \
        OPTIMIZER="${CFLAGS}" \
        USE_SYSTEM_ZLIB=1 \
        ZLIB_LIBS=-lz \
        $(option !debug && echo BUILDOPT=1) \
        build_coreconf build_dbm all
}
src_install() {
    local v
    for v in MAJOR MINOR PATCH; do
        local ${v}=$(sed -n "s/^#define[[:space:]]*NSS_V${v}[[:space:]]*//p" lib/nss/nss.h)
    done

    edo sed -e "s|@LIBDIR@|$LIBDIR|" \
            -e "s|@MAJOR_VERSION@|${MAJOR}|" \
            -e "s|@VERSION@|${MAJOR}.${MINOR}.${PATCH}|" \
            "${FILES}"/nss.pc.in > "${WORK}"/nss.pc

    insinto /usr/$LIBDIR/pkgconfig
    doins "${WORK}"/nss.pc

    dobin "${FILES}"/nss-config

    hereenvd 40nss <<EOF
LDPATH="/usr/$LIBDIR/nss"
EOF

    edo cd ../../dist

    insinto /usr/$LIBDIR/nss
    doins *.OBJ/lib/*.{chk,a}
    exeinto /usr/$LIBDIR/nss
    doexe *.OBJ/lib/*.so

    insinto /usr/include/nss
    doins public/nss/*

    local nssutils
    if option utils ; then
        nssutils="addbuiltin atob baddbdir btoa certcgi certutil checkcert
        cmsutil conflict crlutil derdump digest makepqg mangle modutil multinit
        nonspr10 ocspclnt oidcalc p7content p7env p7sign p7verify pk11mode
        pk12util pp rsaperf selfserv shlibsign signtool signver ssltap strsclnt
        symkeyutil tstclnt vfychain vfyserv"
    fi
    edo cd */bin
    for file in ${nssutils}; do
            dobin ${file}
    done
}
